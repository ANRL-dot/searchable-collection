<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANRL Library Collection Search</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label { font-weight: 600; }
    select, input[type="search"], button { padding: 8px; }
    #term { flex: 1; min-width: 240px; }
    #status { font-size: 13px; color:#444; margin: 6px 0 12px; }
    #err { display:none; color:#b00020; margin: 8px 0; white-space: pre-wrap; }
    .btnrow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0 14px; }
    .table-wrap { width: 100%; overflow-x: auto; }
    .muted { color:#666; font-size: 12px; }
    a.smalllink { font-size:12px; color:#1a73e8; text-decoration: underline; }
    .sheet-wrap { margin-top: 16px; display:none; }
    .sheet-frame { width:100%; height:720px; border:0; }
  </style>
</head>

<body>
  <div class="controls">
    <label for="starts">Title starts with:</label>
    <select id="starts">
      <option value="">Any</option>
      <option value="0-9">0–9</option>
      <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
      <option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option>
      <option value="I">I</option><option value="J">J</option><option value="K">K</option><option value="L">L</option>
      <option value="M">M</option><option value="N">N</option><option value="O">O</option><option value="P">P</option>
      <option value="Q">Q</option><option value="R">R</option><option value="S">S</option><option value="T">T</option>
      <option value="U">U</option><option value="V">V</option><option value="W">W</option><option value="X">X</option>
      <option value="Y">Y</option><option value="Z">Z</option>
    </select>

    <label for="term">Title contains:</label>
    <input id="term" type="search" placeholder="Type a word/phrase (e.g., sunshine, newsletter)">

    <label for="size">Rows:</label>
    <select id="size">
      <option>25</option>
      <option selected>50</option>
      <option>100</option>
    </select>

    <button id="searchBtn" type="button">Search</button>
    <button id="clearBtn" type="button">Clear</button>
  </div>

  <div class="btnrow">
    <button id="prevBtn" type="button" disabled>Prev</button>
    <button id="nextBtn" type="button" disabled>Next</button>
    <span class="muted" id="pageInfo">Page 1</span>
    <button id="toggleSheetBtn" type="button">Show full sheet view</button>
    <a id="testLink" class="smalllink" target="_blank" rel="noopener">Test data connection (CSV)</a>
  </div>

  <div id="status">Ready. Enter a filter and click Search.</div>
  <div id="err"></div>

  <div class="table-wrap">
    <table id="tbl" class="display" style="width:100%"></table>
  </div>

  <div class="sheet-wrap" id="sheetWrap">
    <iframe class="sheet-frame" id="sheetFrame" loading="lazy"></iframe>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SHEET_ID = "1jg0uBKYypfpwCIa7AFel6m-2DWhkG7yDeD8YgWKj1N4";
    const PUBLISHED_KEY =
      "2PACX-1vTGi_JcID6t3FbeF_-Ly4Q-0SBY6jMco19PK8hNcNGO28VheQDFXAgdvUB73Yr7bM9SoWSCXrgJK9-l";

    const GID = "104159087";
    const HEADERS = 1;
    const TITLE_HEADER = "Title"; // must match sheet header exactly

    // Try published first, then fallback to /d/{SHEET_ID}/...
    const GVIZ_BASES = [
      `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/gviz/tq`,
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`
    ];

    const FULL_SHEET_IFRAME =
      `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pubhtml?gid=${GID}&single=true&widget=true&headers=false`;

    // =========================
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const errEl = $("err");

    function setStatus(msg) { statusEl.textContent = msg; }
    function showErr(msg) { errEl.style.display = "block"; errEl.textContent = msg; }
    function clearErr() { errEl.style.display = "none"; errEl.textContent = ""; }

    function escapeQuotes(s) { return String(s).replace(/'/g, "''"); }

    // 0->A, 1->B, ... 25->Z, 26->AA ...
    function colLetter(i) {
      let s = "";
      i += 1;
      while (i > 0) {
        const m = (i - 1) % 26;
        s = String.fromCharCode(65 + m) + s;
        i = Math.floor((i - 1) / 26);
      }
      return s;
    }

    // =========================
    // GViz JSONP with REAL error reporting
    // =========================
    function gvizJsonpQuery(baseUrl, tq) {
      return new Promise((resolve, reject) => {
        const cb = "__gviz_cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        script.async = true;

        const tqx = `responseHandler:${cb}`; // JSONP callback
        const url =
          `${baseUrl}?gid=${encodeURIComponent(GID)}&headers=${encodeURIComponent(HEADERS)}` +
          `&tq=${encodeURIComponent(tq)}&tqx=${encodeURIComponent(tqx)}`;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error(
            "GViz request timed out.\n" +
            "This is usually caused by a blocker or network policy preventing docs.google.com from responding.\n" +
            "Test URL:\n" + url
          ));
        }, 15000);

        function cleanup() {
          clearTimeout(timeout);
          try { delete window[cb]; } catch (_) { window[cb] = undefined; }
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        // IMPORTANT: handle script load failure explicitly
        script.onerror = () => {
          cleanup();
          reject(new Error(
            "GViz script failed to load.\n" +
            "Most common causes:\n" +
            "• Ad blocker / privacy extension blocking docs.google.com\n" +
            "• Corporate network / DNS filtering\n" +
            "• Browser setting blocking third-party scripts\n\n" +
            "Try incognito with extensions OFF, or whitelist docs.google.com.\n\n" +
            "Blocked URL:\n" + url
          ));
        };

        window[cb] = (resp) => {
          cleanup();
          if (!resp || resp.status !== "ok") {
            const e = (resp && resp.errors && resp.errors[0]) ? resp.errors[0] : null;
            const msg = e ? (e.detailed_message || e.message || JSON.stringify(e)) : "Unknown GViz error response.";
            reject(new Error("GViz returned an error:\n" + msg));
            return;
          }
          resolve(resp.table);
        };

        script.src = url;
        document.head.appendChild(script);
      });
    }

    async function gvizQueryWithFallback(tq) {
      let lastErr = null;
      for (const base of GVIZ_BASES) {
        try {
          return await gvizJsonpQuery(base, tq);
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("All GViz endpoints failed.");
    }

    // =========================
    // Paging/filter state
    // =========================
    let schema = null;   // { labels[], titleIdx, titleColLetter }
    let offset = 0;
    let pageSize = Number($("size").value);
    let pageNum = 1;
    let lastRowsReturned = 0;
    let tableDT = null;

    async function loadSchemaOnce() {
      if (schema) return schema;

      setStatus("Loading columns…");
      const t = await gvizQueryWithFallback("select * limit 0");

      const labels = (t.cols || []).map((c, i) => (c.label && c.label.trim()) ? c.label : ("Column " + (i+1)));
      const titleIdx = labels.indexOf(TITLE_HEADER);
      if (titleIdx === -1) {
        throw new Error(
          `Could not find a "${TITLE_HEADER}" header.\n` +
          `Detected headers:\n- ${labels.join("\n- ")}`
        );
      }

      schema = { labels, titleIdx, titleColLetter: colLetter(titleIdx) };
      return schema;
    }

    function buildWhereClause() {
      const parts = [];
      const starts = $("starts").value;
      const term = $("term").value.trim();
      const L = schema.titleColLetter;

      if (starts) {
        if (starts === "0-9") parts.push(`${L} matches '^[0-9]'`);
        else parts.push(`lower(${L}) matches '^${escapeQuotes(starts.toLowerCase())}'`);
      }

      if (term) parts.push(`lower(${L}) contains '${escapeQuotes(term.toLowerCase())}'`);

      return parts.length ? (" where " + parts.join(" and ")) : "";
    }

    function toRowArray(gvizRow, colCount) {
      const cells = gvizRow.c || [];
      const row = new Array(colCount);
      for (let i = 0; i < colCount; i++) {
        const cell = cells[i];
        row[i] = cell ? (cell.f ?? cell.v ?? "") : "";
      }
      return row;
    }

    async function loadPage() {
      try {
        clearErr();
        pageSize = Number($("size").value);

        await loadSchemaOnce();

        const L = schema.titleColLetter;
        const where = buildWhereClause();
        const tq = `select *${where} order by ${L} asc limit ${pageSize} offset ${offset}`;

        setStatus("Loading page…");
        const t = await gvizQueryWithFallback(tq);

        const colCount = (t.cols || []).length;
        const rows = (t.rows || []).map(r => toRowArray(r, colCount));
        lastRowsReturned = rows.length;

        const columns = schema.labels.map(h => ({ title: h }));

        if (!tableDT) {
          tableDT = new DataTable("#tbl", {
            data: rows,
            columns,
            pageLength: pageSize,
            searching: false,
            ordering: true,
            deferRender: true
          });
        } else {
          tableDT.clear();
          tableDT.rows.add(rows);
          tableDT.draw();
        }

        $("pageInfo").textContent = `Page ${pageNum} (showing ${rows.length} rows)`;
        $("prevBtn").disabled = (offset === 0);
        $("nextBtn").disabled = (rows.length < pageSize);

        setStatus("Ready.");
      } catch (e) {
        setStatus("Error");
        showErr(String(e && e.message ? e.message : e));
        $("prevBtn").disabled = true;
        $("nextBtn").disabled = true;
      }
    }

    function resetAndSearch() {
      offset = 0;
      pageNum = 1;
      loadPage();
    }

    // =========================
    // UI wiring
    // =========================
    $("searchBtn").addEventListener("click", resetAndSearch);
    $("term").addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); resetAndSearch(); }
    });
    $("starts").addEventListener("change", resetAndSearch);
    $("size").addEventListener("change", resetAndSearch);

    $("clearBtn").addEventListener("click", () => {
      $("starts").value = "";
      $("term").value = "";
      resetAndSearch();
    });

    $("prevBtn").addEventListener("click", () => {
      if (offset === 0) return;
      offset = Math.max(0, offset - pageSize);
      pageNum = Math.max(1, pageNum - 1);
      loadPage();
    });

    $("nextBtn").addEventListener("click", () => {
      if (lastRowsReturned < pageSize) return;
      offset += pageSize;
      pageNum += 1;
      loadPage();
    });

    let sheetShown = false;
    $("toggleSheetBtn").addEventListener("click", () => {
      const wrap = $("sheetWrap");
      const frame = $("sheetFrame");
      sheetShown = !sheetShown;

      if (sheetShown) {
        frame.src = FULL_SHEET_IFRAME;
        wrap.style.display = "block";
        $("toggleSheetBtn").textContent = "Hide full sheet view";
      } else {
        frame.src = "about:blank";
        wrap.style.display = "none";
        $("toggleSheetBtn").textContent = "Show full sheet view";
      }
    });

    // Build a CSV “test” URL (opens quickly and proves access)
    (function setTestLink(){
      const tq = "select * limit 1";
      const testUrl = `${GVIZ_BASES[0]}?gid=${encodeURIComponent(GID)}&headers=${encodeURIComponent(HEADERS)}&tq=${encodeURIComponent(tq)}&tqx=${encodeURIComponent("out:csv")}`;
      $("testLink").href = testUrl;
    })();

    setStatus("Ready. Enter a filter and click Search.");
  </script>
</body>
</html>
