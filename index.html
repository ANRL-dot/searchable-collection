<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANRL Library Collection Search</title>

  <!-- DataTables 2 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.min.js"></script>

  <!-- Google Charts loader (required for google.visualization.Query) -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label { font-weight: 600; }
    select, input[type="search"], button { padding: 8px; }
    #textSearch { flex: 1; min-width: 240px; }
    #colFilter { min-width: 260px; }
    #status { font-size: 13px; color:#444; margin: 6px 0 12px; }
    #sheetError { display:none; color:#b00020; margin: 8px 0; white-space: pre-wrap; }
    .table-wrap { width: 100%; overflow-x: auto; }
    .section-title { font-weight: 700; margin: 18px 0 8px; }
    .iframe-wrap { width: 100%; height: 720px; }
    iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>

<body>
  <div id="sheet-widget">
    <div class="controls">
      <label for="colFilter">Title:</label>
      <select id="colFilter">
        <option value="">All</option>
      </select>

      <label for="textSearch">Search:</label>
      <input id="textSearch" type="search" placeholder="Type to search all columns..." />

      <button id="searchBtn" type="button">Search</button>
      <button id="clearBtn" type="button">Clear</button>
    </div>

    <div id="status">Loading…</div>
    <div id="sheetError"></div>

    <div class="table-wrap">
      <table id="sheetTable" class="display" style="width:100%"></table>
    </div>

    <div class="section-title">Full Sheet View</div>
    <div class="iframe-wrap">
      <iframe
        loading="lazy"
        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTGi_JcID6t3FbeF_-Ly4Q-0SBY6jMco19PK8hNcNGO28VheQDFXAgdvUB73Yr7bM9SoWSCXrgJK9-l/pubhtml?gid=104159087&single=true&widget=true&headers=false">
      </iframe>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const DATA_SOURCE_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGi_JcID6t3FbeF_-Ly4Q-0SBY6jMco19PK8hNcNGO28VheQDFXAgdvUB73Yr7bM9SoWSCXrgJK9-l/gviz/tq?gid=104159087&headers=1";

    const FILTER_COL_NAME = "Title";  // must match header text exactly
    const PAGE_LENGTH = 25;

    // =========================
    // UI helpers
    // =========================
    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    function showError(msg) {
      const el = document.getElementById("sheetError");
      el.style.display = "block";
      el.textContent = msg;
      setStatus("Error");
    }

    function clearError() {
      const el = document.getElementById("sheetError");
      el.style.display = "none";
      el.textContent = "";
    }

    function escapeRegExp(str) {
      return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // Catch any JS errors so it doesn't silently hang on "Loading…"
    window.addEventListener("error", (e) => {
      showError("JavaScript error:\n" + (e.message || e.error || e));
    });
    window.addEventListener("unhandledrejection", (e) => {
      showError("Unhandled promise rejection:\n" + (e.reason ? (e.reason.message || e.reason) : e));
    });

    // =========================
    // Main
    // =========================
    function build() {
      try {
        // Verify libs
        if (typeof DataTable === "undefined") {
          showError("DataTables did not load (DataTable is undefined).");
          return;
        }
        if (!google || !google.visualization || !google.visualization.Query) {
          showError("Google Visualization API did not load (google.visualization.Query is missing).");
          return;
        }

        setStatus("Requesting data from Google Sheets…");

        const query = new google.visualization.Query(DATA_SOURCE_URL);
        query.setQuery("select *");

        query.send((response) => {
          try {
            if (response.isError()) {
              showError(
                "Google Visualization query error:\n" +
                response.getMessage() + "\n" +
                response.getDetailedMessage()
              );
              return;
            }

            const dt = response.getDataTable();
            const colCount = dt.getNumberOfColumns();
            const rowCount = dt.getNumberOfRows();

            const colLabels = [];
            const columns = [];
            for (let c = 0; c < colCount; c++) {
              const label = dt.getColumnLabel(c) || `Column ${c+1}`;
              colLabels.push(label);
              columns.push({ title: label });
            }

            let filterColIndex = colLabels.indexOf(FILTER_COL_NAME);
            if (filterColIndex === -1) {
              filterColIndex = 0;
              showError(
                `Filter column "${FILTER_COL_NAME}" not found. Using first column instead.\n\n` +
                "Detected headers:\n- " + colLabels.join("\n- ")
              );
            } else {
              clearError();
            }

            const rows = [];
            for (let r = 0; r < rowCount; r++) {
              const row = [];
              for (let c = 0; c < colCount; c++) row.push(dt.getValue(r, c));
              rows.push(row);
            }

            // Create table
            const table = new DataTable("#sheetTable", {
              data: rows,
              columns: columns,
              pageLength: PAGE_LENGTH,
              deferRender: true
            });

            // Populate Title dropdown
            const select = document.getElementById("colFilter");
            select.innerHTML = `<option value="">All</option>`;

            const uniq = Array.from(new Set(
              rows
                .map(r => r[filterColIndex])
                .filter(v => v !== null && v !== undefined && String(v).trim() !== "")
                .map(String)
            )).sort((a,b) => a.localeCompare(b));

            for (const v of uniq) {
              const opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              select.appendChild(opt);
            }

            // Filtering behavior
            select.addEventListener("change", () => {
              const val = select.value;
              if (!val) table.column(filterColIndex).search("").draw();
              else table.column(filterColIndex).search(`^${escapeRegExp(val)}$`, true, false).draw();
            });

            // Search behavior (Enter + button + typing)
            const search = document.getElementById("textSearch");
            const runSearch = () => table.search(search.value).draw();

            search.addEventListener("input", runSearch);
            search.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                runSearch();
              }
            });
            document.getElementById("searchBtn").addEventListener("click", runSearch);

            // Clear
            document.getElementById("clearBtn").addEventListener("click", () => {
              select.value = "";
              search.value = "";
              table.search("");
              table.column(filterColIndex).search("");
              table.draw();
            });

            setStatus(`Loaded ${rowCount.toLocaleString()} rows, ${colCount} columns.`);
          } catch (err) {
            showError("Callback error:\n" + (err && err.message ? err.message : String(err)));
          }
        });
      } catch (err) {
        showError("Build error:\n" + (err && err.message ? err.message : String(err)));
      }
    }

    // If Google Charts never finishes loading, stop the "Loading…" spinner and show a message.
    const loadTimeout = setTimeout(() => {
      if (document.getElementById("status").textContent.includes("Loading")) {
        showError("Timed out waiting for Google Charts to initialize.\nIf this persists, a browser extension/network policy may be blocking https://www.gstatic.com/charts/loader.js");
      }
    }, 8000);

    // Load Google Charts
    document.addEventListener("DOMContentLoaded", () => {
      try {
        if (!window.google || !google.charts) {
          showError("Google Charts loader not available (loader.js did not load).");
          return;
        }
        google.charts.load("current", { packages: ["table"] });
        google.charts.setOnLoadCallback(() => {
          clearTimeout(loadTimeout);
          build();
        });
      } catch (err) {
        showError("Init error:\n" + (err && err.message ? err.message : String(err)));
      }
    });
  </script>
</body>
</html>
