<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ANRL Library Collection Search</title>

  <!-- DataTables 2 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.6/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.min.js"></script>

  <!-- Google Charts loader (needed for google.visualization.Query) -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label { font-weight: 600; }
    select, input[type="search"], button { padding: 8px; }
    #textSearch { flex: 1; min-width: 240px; }
    #colFilter { min-width: 260px; }
    #status { font-size: 13px; color:#444; margin: 6px 0 12px; }
    #sheetError { display:none; color:#b00020; margin: 8px 0; white-space: pre-wrap; }
    .table-wrap { width: 100%; overflow-x: auto; }
    .section-title { font-weight: 700; margin: 18px 0 8px; }
    .iframe-wrap { width: 100%; height: 720px; }
    iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>

<body>
  <div id="sheet-widget">
    <div class="controls">
      <label for="colFilter">Title:</label>
      <select id="colFilter">
        <option value="">All</option>
      </select>

      <label for="textSearch">Search:</label>
      <input id="textSearch" type="search" placeholder="Type to search all columns..." />

      <button id="clearBtn" type="button">Clear</button>
    </div>

    <div id="status">Loading…</div>
    <div id="sheetError"></div>

    <div class="table-wrap">
      <table id="sheetTable" class="display" style="width:100%"></table>
    </div>

    <div class="section-title">Full Sheet View</div>
    <div class="iframe-wrap">
      <iframe
        loading="lazy"
        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTGi_JcID6t3FbeF_-Ly4Q-0SBY6jMco19PK8hNcNGO28VheQDFXAgdvUB73Yr7bM9SoWSCXrgJK9-l/pubhtml?gid=104159087&single=true&widget=true&headers=false">
      </iframe>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================

    // Use the PUBLISHED (2PACX...) form for maximum reliability
    // (This avoids any “share link” mismatch vs what is published.)
    const DATA_SOURCE_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGi_JcID6t3FbeF_-Ly4Q-0SBY6jMco19PK8hNcNGO28VheQDFXAgdvUB73Yr7bM9SoWSCXrgJK9-l/gviz/tq?gid=104159087&headers=1";

    const FILTER_COL_NAME = "Title";  // must match the header text exactly
    const PAGE_LENGTH = 25;

    // =========================
    // Helpers
    // =========================
    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    function showError(msg) {
      const el = document.getElementById("sheetError");
      el.style.display = "block";
      el.textContent = msg;
      setStatus("Error");
    }

    function escapeRegExp(str) {
      return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // =========================
    // Main
    // =========================
    function build() {
      if (typeof DataTable === "undefined") {
        showError("DataTables failed to load.");
        return;
      }

      setStatus("Requesting data from Google Sheets…");

      const query = new google.visualization.Query(DATA_SOURCE_URL);
      query.setQuery("select *");

      query.send((response) => {
        if (response.isError()) {
          showError(
            "Google Visualization query error:\n" +
            response.getMessage() + "\n" +
            response.getDetailedMessage() + "\n\n" +
            "Fixes to try:\n" +
            "1) Google Sheet: File → Share → Publish to web (tab) and ensure it’s published.\n" +
            "2) Google Sheet: Share → General access → Anyone with the link → Viewer.\n" +
            "3) Confirm the gid matches the tab you want (gid=104159087)."
          );
          return;
        }

        const dt = response.getDataTable();
        const colCount = dt.getNumberOfColumns();
        const rowCount = dt.getNumberOfRows();

        // Column labels
        const colLabels = [];
        const columns = [];
        for (let c = 0; c < colCount; c++) {
          const label = dt.getColumnLabel(c) || `Column ${c+1}`;
          colLabels.push(label);
          columns.push({ title: label });
        }

        // Identify filter column index
        let filterColIndex = colLabels.indexOf(FILTER_COL_NAME);
        if (filterColIndex === -1) {
          filterColIndex = 0;
          showError(`Filter column "${FILTER_COL_NAME}" not found in headers. Using first column instead.\nDetected headers:\n- ${colLabels.join("\n- ")}`);
        } else {
          // Clear any prior error
          const el = document.getElementById("sheetError");
          el.style.display = "none";
          el.textContent = "";
        }

        // Data rows
        const rows = [];
        for (let r = 0; r < rowCount; r++) {
          const row = [];
          for (let c = 0; c < colCount; c++) row.push(dt.getValue(r, c));
          rows.push(row);
        }

        // Build DataTable UI
        const table = new DataTable("#sheetTable", {
          data: rows,
          columns: columns,
          pageLength: PAGE_LENGTH,
          deferRender: true
        });

        // Populate dropdown from unique values in filter column
        const select = document.getElementById("colFilter");
        // Reset options (keeps All)
        select.innerHTML = `<option value="">All</option>`;

        const uniq = Array.from(new Set(
          rows
            .map(r => r[filterColIndex])
            .filter(v => v !== null && v !== undefined && String(v).trim() !== "")
            .map(String)
        )).sort((a,b) => a.localeCompare(b));

        for (const v of uniq) {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        }

        // Dropdown exact match
        select.addEventListener("change", () => {
          const val = select.value;
          if (!val) table.column(filterColIndex).search("").draw();
          else table.column(filterColIndex).search(`^${escapeRegExp(val)}$`, true, false).draw();
        });

        // Global text search
        const search = document.getElementById("textSearch");
        search.addEventListener("input", () => table.search(search.value).draw());

        // Clear
        document.getElementById("clearBtn").addEventListener("click", () => {
          select.value = "";
          search.value = "";
          table.search("");
          table.column(filterColIndex).search("");
          table.draw();
        });

        setStatus(`Loaded ${rowCount.toLocaleString()} rows, ${colCount} columns.`);
      });
    }

    // Load Google Charts (required for google.visualization.Query)
    if (!window.google || !google.charts) {
      showError("Google Charts loader did not initialize (blocked by network or browser).");
    } else {
      google.charts.load("current", { packages: ["table"] });
      google.charts.setOnLoadCallback(build);
    }
  </script>
</body>
</html>
